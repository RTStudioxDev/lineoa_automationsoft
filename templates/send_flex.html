{% extends "base.html" %}
{% block content %}
<style>
/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å */
.send-flex-container {
    background: #f6fff6;
    border-radius: 18px;
    box-shadow: 0 4px 24px rgba(46,125,50,0.07), 0 0 0 1px #e7fbe6;
    padding: 24px 24px 4px 24px;
    max-width: 2000px;
    margin: 32px 0 0 -280px !important;
}

.send-flex-container h2 {
    font-weight: 700;
    color: #097c22;
    margin-bottom: 18px;
    font-size: 2em;
    letter-spacing: 0.5px;
}

.send-flex-container label {
    font-weight: 500;
    color: #17723c;
    margin-bottom: 7px;
    display: block;
    font-size: 1.07em;
}

.send-flex-container select,
.send-flex-container input[type="datetime-local"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #d7efde;
    background: #fff;
    font-size: 1em;
    margin-bottom: 18px;
    box-sizing: border-box;
    transition: border 0.18s;
}
.send-flex-container select:focus,
.send-flex-container input[type="datetime-local"]:focus {
    border: 1.5px solid #22bb66;
    outline: none;
}

#flex_preview {
    margin: 14px 0 22px 0 !important;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 18px #e3f6e0;
    padding: 18px 10px;
    min-height: 220px;
    display: flex;
    justify-content: center;
    align-items: center;
    max-width: 100%;
    width: 100%;
}
#flex_preview img {
    border-radius: 18px;
    box-shadow: 0 2px 18px #e7fbe6;
    margin: 0 auto;
    display: block;
    max-width: 100%;
    max-height: 400px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
    width: 100%;
    height: auto;
    object-fit: contain;
    background: #f8f8f8;
}

.send-flex-container .btn {
    background: #008f36;
    color: #fff;
    border: none;
    border-radius: 9px;
    padding: 10px 26px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px #e8fce2;
    transition: background 0.18s, color 0.18s;
}
.send-flex-container .btn:hover,
.send-flex-container .btn:focus {
    background: #0dbe5a;
    color: #fff;
}
.send-flex-container .btn-outline {
    background: #fff !important;
    color: #008f36 !important;
    border: 2px solid #008f36;
    box-shadow: none;
}
.send-flex-container .btn-outline:hover {
    background: #e7fbe6 !important;
    color: #0dbe5a !important;
    border: 2px solid #0dbe5a;
}

#send-flex-form {
    margin-top: 16px;
}

@media (max-width: 850px) {
    .send-flex-container {
        padding: 6vw 2vw 6vw 2vw;
        max-width: 98vw;
    }
    #flex_preview img {
        max-width: 99vw;
        max-height: 160px;
    }
}
@media (max-width: 600px) {
    .send-flex-container {
        border-radius: 9px;
        padding: 4vw 1vw 4vw 1vw;
    }
    #flex_preview {
        padding: 10px 2px;
    }
}
input[type="radio"] {
    accent-color: #008f36;
    margin-right: 3px;
}

/* Progress Modal */
.progress-modal {
    position: fixed;
    z-index: 10000;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(26,54,30,0.13);
    display: flex;
    align-items: center;
    justify-content: center;
}
.progress-modal-content {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 20px #e7fbe6;
    padding: 28px 32px 22px 32px;
    min-width: 340px;
    max-width: 98vw;
    text-align: center;
}
.progress-title {
    font-weight: 600;
    color: #007a4d;
    font-size: 1.15em;
}
.progress-bar-container {
    margin: 18px 0 9px 0;
    height: 18px;
    width: 100%;
    border-radius: 7px;
    background: #f2ffed;
    box-shadow: 0 1px 4px #e7fbe6;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #25a154, #7ee885);
    border-radius: 7px;
    width: 0%;
    transition: width 0.4s;
}
.btn-danger {
    background: #f4cccc !important;
    color: #d52b1e !important;
    border-radius: 8px;
    margin-top: 16px;
    font-weight: 600;
    padding: 9px 26px;
    border: none;
}
.btn-danger:hover {
    background: #e44f43 !important;
    color: #fff !important;
}
</style>
<div class="send-flex-container">
    <h2 style="font-weight: 700; color: #097c22; margin-bottom: 36px; text-align: center;">
        ‡∏™‡πà‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à
    </h2>
    <form method="post" id="send-flex-form">
        <label >‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:</label>
        <select id="template_select" name="selected_template" onchange="onSelectTemplate(this)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à --</option>
            {% for temp in templates %}
                <option value="{{ temp.name }}" {% if selected_template == temp.name %}selected{% endif %}>{{ temp.name }}</option>
            {% endfor %}
        </select>
        <!-- ‡∏ã‡πà‡∏≠‡∏ô Flex JSON -->
        <input type="hidden" id="flex_json" name="flex_json" value='{{ flex_json|tojson if flex_json else "" }}'>

        <!-- Flex Live Preview -->
        <div style="margin:30px 0 0 0;">
            <label style="font-weight:bold;color:#165a31;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á:</label>
            <div id="flex_preview"
                style="background:#fff;border-radius:20px;box-shadow:0 2px 24px #ccc;padding:18px 28px;width:400px;min-height:220px;max-width:99vw;">
                <em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>
            </div>
        </div>

        <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á:</label>
        <div style="display: flex; gap: 14px; align-items: center; margin-bottom: 16px;">
            <label>
                <input type="radio" name="send_time_option" value="now" checked> ‡∏™‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            </label>
            <label>
                <input type="radio" name="send_time_option" value="schedule"> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á
            </label>
            <input type="datetime-local" name="scheduled_time" id="scheduled_time" style="display:none;">
        </div>

        <br>
        <label>‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á:</label>
        <select name="target" required>
            <option value="broadcast">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Broadcast)</option>
            {% for user_id in user_ids %}
                <option value="{{ user_id }}">{{ user_id }}</option>
            {% endfor %}
        </select>
        <br>
        <div style="display:flex; gap: 14px;">
            <button type="submit" class="btn">
                <span style="font-size:1.15em;vertical-align:middle;margin-right:6px;">üöÄ</span>
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à
            </button>
            <a href="{{ url_for('flex_templates_list') }}" target="_blank" rel="noopener"
                class="btn btn-outline" style="background:#fff;color:#008f36;border:2px solid #008f36;font-weight:600;">
                <span style="vertical-align:middle;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à</span>
                <svg style="vertical-align:middle;margin-left:4px;" width="18" height="18" viewBox="0 0 20 20" fill="none">
                    <path d="M7 13L13 7M13 7H8M13 7V12" stroke="#008f36" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </div>
    </form>

    <!-- Progress Popup Modal -->
    <div id="sendProgressModal" class="progress-modal" style="display:none;">
        <div class="progress-modal-content">
            <span class="progress-title">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à...</span>
            <div class="progress-info">
                <span id="progressStatusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡πà‡∏á...</span>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <span id="progressCount"></span>
            </div>
            <button id="cancelSendBtn" class="btn btn-danger">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
        </div>
    </div>
{{ super() }}
</div>
<script>
    // @ts-nocheck
    window.templates = {{ templates|tojson|safe }};
    const templateSelect = document.getElementById('template_select');
    const previewDiv = document.getElementById('flex_preview');
    const flexJsonInput = document.getElementById('flex_json');
    let sendProgressInterval;

    templateSelect.onchange = function() {
      const name = this.value;
      let flexJson = "";
      if (name) {
          const found = window.templates.find(t => t.name === name);
          if (found) {
              flexJson = JSON.stringify(found.json, null, 2);
              flexJsonInput.value = flexJson;
              renderFlexPreviewFromJson(flexJson);
          }
      } else {
          previewDiv.innerHTML = '<em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>';
          flexJsonInput.value = "";
      }
    };

    function renderFlexPreviewFromJson(jsonStr) {
        let json;
        try { json = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr; }
        catch { previewDiv.innerHTML = '<span style="color:#e74c3c">‚ö†Ô∏è Flex JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>'; return; }
        let html = '';
        if (json.hero && json.hero.url) {
            let aspectRatio = [20, 13];
            let arStr = json.hero.aspectRatio || "";
            if (arStr) {
                let s = arStr.split(":");
                if (s.length === 2) aspectRatio = [+s[0], +s[1]];
            }
            let w = "100%";
            let h = "auto"; // ‡πÉ‡∏´‡πâ auto ‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á

            // ‡∏õ‡∏£‡∏±‡∏ö object-fit ‡∏ï‡∏≤‡∏° mode ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            let aspectMode = (json.hero.aspectMode || 'cover');
            let fitStyle = (aspectMode === 'fit')
                ? "object-fit:contain;background:#f8f8f8;"
                : "object-fit:cover;background:#f8f8f8;";

            // ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (responsive)
            html += `<div style="width:100%;max-width:700px;margin:0 auto;border-radius:18px;overflow:hidden;box-shadow:0 2px 24px #ccc;">`;
            html += `<img src="${json.hero.url}" alt="" 
                    style="display:block;width:100%;height:auto;max-height:400px;${fitStyle}">`;
            html += `</div>`;

            html += '<div style="padding:10px 0 0 0;text-align:center">';
            if (json.body && json.body.contents && json.body.contents[0]) {
                let t = json.body.contents[0];
                if (t.type === "box" && t.contents && t.contents[0] && t.contents[0].type === "text") {
                    html += `<div style="font-size:1.15em;font-weight:bold;color:${t.contents[0].color||'#228B22'}">${t.contents[0].text||''}</div>`;
                } else if (t.type === "text") {
                    html += `<div style="font-size:1.15em;font-weight:bold;color:${t.color||'#228B22'}">${t.text||''}</div>`;
                }
            }
            html += '</div>';
            if (arStr) {
                html += `<div style="text-align:center;font-size:.97em;color:#666;margin:3px 0 0 0;">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ: ${arStr}</div>`;
            }
        }
        if (!html) html = '<em>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô Flex JSON</em>';
        previewDiv.innerHTML = html;
    }

    // Show preview ‡πÄ‡∏°‡∏∑‡πà‡∏≠ load page
    document.addEventListener('DOMContentLoaded', function() {
        let sel = templateSelect.value;
        if (sel) templateSelect.onchange();
        else previewDiv.innerHTML = '<em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>';
    });

    // Progress Modal ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    document.getElementById('send-flex-form').onsubmit = function(e) {
        openSendModal();
        sendProgressInterval = setInterval(function() {
            fetch('/send_progress').then(r=>r.json()).then(d=>{
                updateProgressUI(d.current, d.total, d.fail || 0);
                if (d.done) {
                    setTimeout(closeSendModal, 1000);
                    clearInterval(sendProgressInterval);
                }
            });
        }, 800);
    };
    document.getElementById('cancelSendBtn').onclick = function() {
        fetch('/cancel_send', {method:'POST'}).then(()=>window.location.reload());
    };
    function openSendModal() {
        document.getElementById('sendProgressModal').style.display = "flex";
        updateProgressUI(0, 0, 0);
    }
    function closeSendModal() {
        document.getElementById('sendProgressModal').style.display = "none";
    }
    function updateProgressUI(current, total, fail) {
        let percent = total ? Math.floor((current/total)*100) : 0;
        document.getElementById('progressBar').style.width = percent + "%";
        document.getElementById('progressStatusText').innerText =
            `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${current} / ${total} ‡∏Ñ‡∏ô${fail ? ", ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß " + fail + " ‡∏Ñ‡∏ô" : ""}`;
        document.getElementById('progressCount').innerText = `(${percent}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)`;
    }
    document.querySelectorAll('input[name="send_time_option"]').forEach(radio => {
        radio.onchange = function() {
            document.getElementById('scheduled_time').style.display = (this.value === 'schedule') ? '' : 'none';
        }
    });
</script>
{% endblock %}
