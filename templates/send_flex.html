{% extends "base.html" %}
{% block content %}
    <h2>‡∏™‡πà‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à</h2>
    <form method="post" id="send-flex-form">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:</label>
        <select id="template_select" name="selected_template" onchange="onSelectTemplate(this)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à --</option>
            {% for temp in templates %}
                <option value="{{ temp.name }}" {% if selected_template == temp.name %}selected{% endif %}>{{ temp.name }}</option>
            {% endfor %}
        </select>
        <!-- ‡∏ã‡πà‡∏≠‡∏ô Flex JSON -->
        <input type="hidden" id="flex_json" name="flex_json" value='{{ flex_json|tojson if flex_json else "" }}'>

        <!-- Flex Live Preview -->
        <div style="margin:30px 0 0 0;">
            <label style="font-weight:bold;color:#165a31;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á:</label>
            <div id="flex_preview"
                style="background:#fff;border-radius:20px;box-shadow:0 2px 24px #ccc;padding:18px 28px;width:400px;min-height:220px;max-width:99vw;">
                <em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>
            </div>
        </div>
        <br>
        <label>‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á:</label>
        <select name="target" required>
            <option value="broadcast">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Broadcast)</option>
            {% for user_id in user_ids %}
                <option value="{{ user_id }}">{{ user_id }}</option>
            {% endfor %}
        </select>
        <br>
        <div style="display:flex; gap: 14px;">
            <button type="submit" class="btn">
                <span style="font-size:1.15em;vertical-align:middle;margin-right:6px;">üöÄ</span>
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à
            </button>
            <a href="{{ url_for('flex_templates_list') }}" target="_blank" rel="noopener"
                class="btn btn-outline" style="background:#fff;color:#008f36;border:2px solid #008f36;font-weight:600;">
                <span style="vertical-align:middle;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à</span>
                <svg style="vertical-align:middle;margin-left:4px;" width="18" height="18" viewBox="0 0 20 20" fill="none">
                    <path d="M7 13L13 7M13 7H8M13 7V12" stroke="#008f36" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </div>
    </form>

    <!-- Progress Popup Modal -->
    <div id="sendProgressModal" class="progress-modal" style="display:none;">
        <div class="progress-modal-content">
            <span class="progress-title">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à...</span>
            <div class="progress-info">
                <span id="progressStatusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡πà‡∏á...</span>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <span id="progressCount"></span>
            </div>
            <button id="cancelSendBtn" class="btn btn-danger">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
        </div>
    </div>

  <script>
    // @ts-nocheck
    window.templates = {{ templates|tojson|safe }};
    const templateSelect = document.getElementById('template_select');
    const previewDiv = document.getElementById('flex_preview');
    const flexJsonInput = document.getElementById('flex_json');
    let sendProgressInterval;

    templateSelect.onchange = function() {
      const name = this.value;
      let flexJson = "";
      if (name) {
          const found = window.templates.find(t => t.name === name);
          if (found) {
              flexJson = JSON.stringify(found.json, null, 2);
              flexJsonInput.value = flexJson;
              renderFlexPreviewFromJson(flexJson);
          }
      } else {
          previewDiv.innerHTML = '<em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>';
          flexJsonInput.value = "";
      }
    };

    function renderFlexPreviewFromJson(jsonStr) {
        let json;
        try { json = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr; }
        catch { previewDiv.innerHTML = '<span style="color:#e74c3c">‚ö†Ô∏è Flex JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>'; return; }
        let html = '';
        if (json.hero && json.hero.url) {
            let aspectRatio = [20, 13];
            let arStr = json.hero.aspectRatio || "";
            if (arStr) {
                let s = arStr.split(":");
                if (s.length === 2) aspectRatio = [+s[0], +s[1]];
            }
            let w = 320;
            let h = Math.round(w * aspectRatio[1] / aspectRatio[0]);
            let aspectMode = (json.hero.aspectMode || 'cover');
            let fitStyle = (aspectMode === 'fit')
                ? "object-fit:contain;background:#f8f8f8;"
                : "object-fit:cover;background:#f8f8f8;";
            html += `<div style="width:${w}px;margin:0 auto;border-radius:18px;overflow:hidden;box-shadow:0 2px 24px #ccc;">
                <img src="${json.hero.url}" alt="" 
                    style="display:block;width:100%;height:${h}px;${fitStyle}">
            `;
            html += '<div style="padding:6px 0;text-align:center">';
            if (json.body && json.body.contents && json.body.contents[0]) {
                let t = json.body.contents[0];
                if (t.type === "box" && t.contents && t.contents[0] && t.contents[0].type === "text") {
                    html += `<div style="font-size:1.1em;font-weight:bold;color:${t.contents[0].color||'#228B22'}">${t.contents[0].text||''}</div>`;
                } else if (t.type === "text") {
                    html += `<div style="font-size:1.1em;font-weight:bold;color:${t.color||'#228B22'}">${t.text||''}</div>`;
                }
            }
            html += '</div></div>';
            if (arStr) {
                html += `<div style="text-align:center;font-size:.97em;color:#666;margin:3px 0 0 0;">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ: ${arStr}</div>`;
            }
        }
        if (!html) html = '<em>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô Flex JSON</em>';
        previewDiv.innerHTML = html;
    }

    // Show preview ‡πÄ‡∏°‡∏∑‡πà‡∏≠ load page
    document.addEventListener('DOMContentLoaded', function() {
        let sel = templateSelect.value;
        if (sel) templateSelect.onchange();
        else previewDiv.innerHTML = '<em>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏¥‡∏ä‡πÄ‡∏°‡∏™‡πÄ‡∏™‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</em>';
    });

    // Progress Modal ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    document.getElementById('send-flex-form').onsubmit = function(e) {
        openSendModal();
        sendProgressInterval = setInterval(function() {
            fetch('/send_progress').then(r=>r.json()).then(d=>{
                updateProgressUI(d.current, d.total, d.fail || 0);
                if (d.done) {
                    setTimeout(closeSendModal, 1000);
                    clearInterval(sendProgressInterval);
                }
            });
        }, 800);
    };
    document.getElementById('cancelSendBtn').onclick = function() {
        fetch('/cancel_send', {method:'POST'}).then(()=>window.location.reload());
    };
    function openSendModal() {
        document.getElementById('sendProgressModal').style.display = "flex";
        updateProgressUI(0, 0, 0);
    }
    function closeSendModal() {
        document.getElementById('sendProgressModal').style.display = "none";
    }
    function updateProgressUI(current, total, fail) {
        let percent = total ? Math.floor((current/total)*100) : 0;
        document.getElementById('progressBar').style.width = percent + "%";
        document.getElementById('progressStatusText').innerText =
            `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${current} / ${total} ‡∏Ñ‡∏ô${fail ? ", ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß " + fail + " ‡∏Ñ‡∏ô" : ""}`;
        document.getElementById('progressCount').innerText = `(${percent}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)`;
    }
</script>
{% endblock %}
