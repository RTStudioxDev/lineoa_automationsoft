{% extends "base.html" %}
{% block content %}
    <h2>‡∏™‡πà‡∏á Flex Message (Rich Message)</h2>
    <form method="post">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:</label>
        <select id="template_select" onchange="onSelectTemplate(this)">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà --</option>
            {% for temp in templates %}
                <option value="{{ temp.name }}" {% if selected_template == temp.name %}selected{% endif %}>{{ temp.name }}</option>
            {% endfor %}
        </select>
        <br>
        <label>Flex JSON ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á(‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ):</label><br>
        <textarea id="flex_json" name="flex_json" rows="18" cols="70" required style="width:100%;font-family:monospace;">
{{ flex_json or
'''{
  "type": "bubble",
  "hero": {
    "type": "image",
    "url": "https://www.linefriends.com/img/myimg.png",
    "size": "full",
    "aspectRatio": "1040:1040",
    "aspectMode": "cover",
    "action": {
      "type": "uri",
      "label": "action",
      "uri": "http://linecorp.com/"
    }
  },
  "body": {
    "type": "box",
    "layout": "horizontal",
    "contents": [
      {
        "type": "box",
        "layout": "vertical",
        "backgroundColor": "#d1fae5",
        "cornerRadius": "10px",
        "paddingAll": "10px",
        "contents": [
          {
            "type": "text",
            "text": "‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
            "weight": "bold",
            "size": "sm",
            "action": {
              "type": "uri",
              "label": "",
              "uri": "http://linecorp.com/"
            },
            "wrap": true,
            "align": "center",
            "color": "#228B22"
          }
        ]
      }
    ],
    "borderWidth": "none",
    "backgroundColor": "#d1fae5",
    "paddingAll": "none",
    "paddingTop": "none",
    "paddingBottom": "none",
    "paddingStart": "none",
    "paddingEnd": "none",
    "offsetTop": "none",
    "offsetBottom": "none",
    "offsetStart": "none",
    "offsetEnd": "none"
  }
}'''
}}
        </textarea>
        <!-- Flex Live Preview -->
        <div style="margin:30px 0 0 0;">
          <label style="font-weight:bold;color:#165a31;">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Flex ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á:</label>
          <div id="flex_preview"
              style="background:#fff;border-radius:20px;box-shadow:0 2px 24px #ccc;padding:18px 28px;width:400px;min-height:220px;max-width:99vw;">
              <em>‡πÉ‡∏™‡πà Flex JSON ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</em>
          </div>
      </div>
        <br>

        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á Flex:</label>
        <input type="text" name="alt_text" value="(‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏° Flex)">
        <br>
        <label>‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á:</label>
        <select name="target" required>
            <option value="broadcast">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Broadcast)</option>
            {% for user_id in user_ids %}
                <option value="{{ user_id }}">{{ user_id }}</option>
            {% endfor %}
        </select>
        <br>
        <div style="display:flex; gap: 14px;">
          <button type="submit" class="btn">
            <span style="font-size:1.15em;vertical-align:middle;margin-right:6px;">üöÄ</span>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Flex
          </button>
          <a href="https://developers.line.biz/flex-simulator/" target="_blank" rel="noopener" 
            class="btn btn-outline" style="background:#fff;color:#008f36;border:2px solid #008f36;font-weight:600;">
              <span style="vertical-align:middle;">‡∏™‡∏£‡πâ‡∏≤‡∏á Flex (LINE Flex Simulator)</span>
              <svg style="vertical-align:middle;margin-left:4px;" width="18" height="18" viewBox="0 0 20 20" fill="none">
                  <path d="M7 13L13 7M13 7H8M13 7V12" stroke="#008f36" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
          </a>
      </div>
    </form>
    <!-- Progress Popup Modal -->
  <div id="sendProgressModal" class="progress-modal" style="display:none;">
    <div class="progress-modal-content">
      <span class="progress-title">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á Flex Message...</span>
      <div class="progress-info">
        <span id="progressStatusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡πà‡∏á...</span>
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <span id="progressCount"></span>
      </div>
      <button id="cancelSendBtn" class="btn btn-danger">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
    </div>
  </div>
    <br>
    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Flex Template</h3>
    <form method="post" action="{{ url_for('save_flex_template') }}">
        <label>‡∏ä‡∏∑‡πà‡∏≠ Template:</label>
        <input type="text" name="template_name" required>
        <br>
        <label>Flex JSON ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</label><br>
        <textarea name="flex_json" id="save_flex_json" style="width:100%;height:300px;">{{ flex_json|e }}</textarea>
        <br>
        <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô Template</button>
    </form>
    {% if templates %}
      <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Flex Template ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h4>
      <table style="width:100%;margin-bottom:18px;">
        <tr>
          <th style="text-align:left;">‡∏ä‡∏∑‡πà‡∏≠ Template</th>
          <th style="text-align:center;width:80px;">‡∏•‡∏ö</th>
        </tr>
        {% for temp in templates %}
          <tr>
            <td style="padding:6px 12px;">{{ temp.name }}</td>
            <td style="text-align:center;">
              <form method="post" action="{{ url_for('delete_flex_template', template_name=temp.name) }}"
                    onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Template: {{ temp.name }} ?');" style="display:inline;">
                <button type="submit" class="btn btn-danger" style="padding:3px 12px;font-size:1em;">‡∏•‡∏ö</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% endif %}
    <script>
      // Sync textarea ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏±‡∏ö textarea save template
      document.addEventListener('DOMContentLoaded', function() {
          var flexMain = document.getElementById('flex_json');
          var flexSave = document.getElementById('save_flex_json');
          if (flexMain && flexSave) flexSave.value = flexMain.value;
          if (flexMain && flexSave) {
              flexMain.addEventListener('input', function() {
                  flexSave.value = flexMain.value;
              });
          }
      });
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å template, redirect ‡∏û‡∏£‡πâ‡∏≠‡∏° query string ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î JSON ‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
      function onSelectTemplate(sel) {
          var name = sel.value;
          if (name) {
              window.location.href = "?selected_template=" + encodeURIComponent(name);
          } else {
              window.location.href = "?";
          }
      }
      function openFlexPreview() {
        var json = document.getElementById('flex_json').value;
        var encoded = btoa(unescape(encodeURIComponent(json)));
        var url = "https://developers.line.biz/flex-simulator/#data=" + encoded;
        window.open(url, "_blank");
      }
      
      function parseAspectRatio(ratioStr) {
        // ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "20:13", "1.51:1" ‡∏´‡∏£‡∏∑‡∏≠ "4:3"
        if (!ratioStr) return [20,13]; // default LINE
        let s = ratioStr.split(':');
        if (s.length === 2) return [+s[0], +s[1]];
        if (s.length === 1 && !isNaN(+s[0])) return [+s[0], 1];
        return [20,13];
      }

      // ==== Live Flex Preview ====
      function renderFlexPreview() {
          let json;
          try {
              json = JSON.parse(document.getElementById('flex_json').value);
          } catch {
              document.getElementById('flex_preview').innerHTML =
                  '<span style="color:#e74c3c">‚ö†Ô∏è Flex JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
              return;
          }
          let html = '';
          // Hero image
          if (json.hero && json.hero.url) {
              let aspectRatio = [20, 13];
              let arStr = json.hero.aspectRatio || "";
              if (arStr) aspectRatio = parseAspectRatio(arStr);
              let w = 320;  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á preview (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ 340, 360 ‡πÑ‡∏î‡πâ)
              let h = Math.round(w * aspectRatio[1] / aspectRatio[0]);
              let aspectMode = (json.hero.aspectMode || 'cover');
              let fitStyle = (aspectMode === 'fit')
                  ? "object-fit:contain;background:#f8f8f8;"
                  : "object-fit:cover;background:#f8f8f8;";
              // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö backgroundColor ‡∏Ç‡∏≠‡∏á bubble
              let bubbleBg = json.body && json.body.contents &&
                            json.body.contents[0] && json.body.contents[0].backgroundColor
                            ? json.body.contents[0].backgroundColor : '#cfeaf4';
              html += `<div style="width:${w}px;margin:0 auto;border-radius:18px;overflow:hidden;background:${bubbleBg};box-shadow:0 2px 24px #ccc;">
                  <img src="${json.hero.url}" alt="" 
                      style="display:block;width:100%;height:${h}px;${fitStyle}">
              `;
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ body ‡∏´‡∏£‡∏∑‡∏≠ footer ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
              html += '<div style="padding:6px 0;text-align:center">';
              // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
              if (json.body && json.body.contents && json.body.contents[0]) {
                  let t = json.body.contents[0];
                  if (t.type === "box" && t.contents && t.contents[0] && t.contents[0].type === "text") {
                      html += `<div style="font-size:1.1em;font-weight:bold;color:${t.contents[0].color||'#228B22'}">${t.contents[0].text||''}</div>`;
                  } else if (t.type === "text") {
                      html += `<div style="font-size:1.1em;font-weight:bold;color:${t.color||'#228B22'}">${t.text||''}</div>`;
                  }
              }
              html += '</div></div>';
              // ‡πÅ‡∏™‡∏î‡∏á aspectRatio ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
              if (arStr) {
                  html += `<div style="text-align:center;font-size:.97em;color:#666;margin:3px 0 0 0;">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ: ${arStr}</div>`;
              }
          }
          // Body
          if (json.body && json.body.contents) {
              html += '<div style="padding:18px 0;">';
              for (let c of json.body.contents) {
                  if (c.type === "text") {
                      html += `<div style="font-size:${c.size=='xl'?'1.4em':'1em'};font-weight:${c.weight=='bold'?'bold':'normal'};color:${c.color||'#222'};margin-bottom:8px;">${c.text||''}</div>`;
                  }
              }
              html += '</div>';
          }
          // Footer (buttons)
          if (json.footer && json.footer.contents) {
              html += '<div style="display:flex;gap:14px;">';
              for (let c of json.footer.contents) {
                  if (c.type === "button" && c.action) {
                      let label = c.action.label || "‡∏õ‡∏∏‡πà‡∏°";
                      html += `<a href="${c.action.uri||'#'}" target="_blank"
                          style="background:#008f36;color:#fff;padding:8px 20px;border-radius:8px;text-decoration:none;font-weight:600;box-shadow:0 2px 8px #c9f7d2;">
                          ${label}
                      </a>`;
                  }
              }
              html += '</div>';
          }
          if (!html) html = '<em>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô Flex JSON</em>';
          document.getElementById('flex_preview').innerHTML = html;
      }

      document.getElementById('flex_json').addEventListener('input', renderFlexPreview);
      document.addEventListener('DOMContentLoaded', renderFlexPreview);

      document.querySelector("form").onsubmit = function(e) {
      openSendModal();
      sendProgressInterval = setInterval(function() {
        fetch('/send_progress').then(r=>r.json()).then(d=>{
          updateProgressUI(d.current, d.total, d.fail || 0);
          if (d.done) {
            setTimeout(closeSendModal, 1000);
            clearInterval(sendProgressInterval);
          }
        });
      }, 800);
    };
    document.getElementById('cancelSendBtn').onclick = function() {
      fetch('/cancel_send', {method:'POST'}).then(()=>window.location.reload());
    };
    function openSendModal() {
      document.getElementById('sendProgressModal').style.display = "flex";
      updateProgressUI(0, 0, 0);
    }
    function closeSendModal() {
      document.getElementById('sendProgressModal').style.display = "none";
    }
    function updateProgressUI(current, total, fail) {
      let percent = total ? Math.floor((current/total)*100) : 0;
      document.getElementById('progressBar').style.width = percent + "%";
      document.getElementById('progressStatusText').innerText =
        `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${current} / ${total} ‡∏Ñ‡∏ô${fail ? ", ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß " + fail + " ‡∏Ñ‡∏ô" : ""}`;
      document.getElementById('progressCount').innerText = `(${percent}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)`;
    }
    </script>
{% endblock %}
