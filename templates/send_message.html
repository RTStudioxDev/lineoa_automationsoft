{% extends "base.html" %}
{% block content %}
    <h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>
    <form method="post" enctype="multipart/form-data">
        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</label>
        <textarea name="text" rows="4" style="width:100%;resize:vertical;" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."></textarea>

        <label>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå):</label>
        <input type="url" name="image_url" id="image_url" placeholder="‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ">
        <div style="display:flex; gap: 14px;">
            <a href="https://pic.in.th/" target="_blank" rel="noopener" 
                class="btn">
                <span>‡∏ù‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ</span>
            </a>    
        </div>  
        <div id="image_preview" style="margin:14px 0;"></div>

        <label>‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á:</label>
        <select name="target" required style="width:100%;">
            <option value="broadcast">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Broadcast)</option>
            {% for user_id in user_ids %}
                <option value="{{ user_id }}">{{ user_id }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn">
            <span style="font-size:1.15em;vertical-align:middle;margin-right:6px;">üöÄ</span>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </button>
    </form>
    {% if uploaded_image_url %}
        <div style="margin:12px 0;">
            <strong>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong><br>
            <img src="{{ uploaded_image_url }}" style="max-width:320px;max-height:220px;border-radius:10px;box-shadow:0 2px 12px #bbb;">
        </div>
    {% endif %}

    <!-- Popup Modal -->
    <div id="sendProgressModal" class="progress-modal" style="display:none;">
    <div class="progress-modal-content">
        <span class="progress-title">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</span>
        <div class="progress-info">
        <span id="progressStatusText">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡πà‡∏á...</span>
        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <span id="progressCount"></span>
        </div>
        <button id="cancelSendBtn" class="btn btn-danger">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
    </div>
    </div>

    <script>
    document.getElementById('image_url').oninput = function(evt) {
        const preview = document.getElementById('image_preview');
        const url = this.value;
        if (url && /^https?:\/\/.+\.(jpg|jpeg|png|gif)$/i.test(url)) {
            preview.innerHTML = `<img src="${url}" style="max-width:320px;max-height:220px;border-radius:10px;box-shadow:0 2px 12px #bbb;">`;
        } else {
            preview.innerHTML = "";
        }
    };

    let sending = false;
    let sendProgressInterval = null;

    // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á
    function openSendModal() {
    document.getElementById('sendProgressModal').style.display = "flex";
    updateProgressUI(0, 0, 0); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    }

    // ‡∏õ‡∏¥‡∏î Modal
    function closeSendModal() {
    document.getElementById('sendProgressModal').style.display = "none";
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress UI
    function updateProgressUI(current, total, fail) {
    let percent = total ? Math.floor((current / total) * 100) : 0;
    document.getElementById('progressBar').style.width = percent + "%";
    document.getElementById('progressStatusText').innerText =
        `‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß ${current} / ${total} ‡∏Ñ‡∏ô${fail ? ", ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß " + fail + " ‡∏Ñ‡∏ô" : ""}`;
    document.getElementById('progressCount').innerText =
        `(${percent}% ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)`;
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô submit form
    document.querySelector("form").onsubmit = function(e) {
    openSendModal();
    sending = true;
    // Start polling progress (AJAX)
    sendProgressInterval = setInterval(function() {
        fetch('/send_progress')
        .then(r => r.json())
        .then(d => {
            updateProgressUI(d.current, d.total, d.fail || 0);
            if (d.done) {
            setTimeout(closeSendModal, 800);
            clearInterval(sendProgressInterval);
            }
        });
    }, 800);
    };

    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    document.getElementById('cancelSendBtn').onclick = function() {
    fetch('/cancel_send', {method:'POST'}).then(() => {
        sending = false;
        closeSendModal();
        window.location.reload();
    });
    };
    </script>
{% endblock %}
